---
title: "Team 5 Modeling"
author: "Matt Ammirati"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
library(readr)
library(caret)
library(rsample)
```

```{r}
df <- read_csv('Team5Data.csv')
glimpse(df)
```
```{r}
unique(df$treatment_outcome)
```

```{r}
table(df$treatment_outcome, useNA = "ifany")
```
```{r}
table(df$trial_arm, useNA = 'ifany')
```
```{r}
df_new_target <- df %>%
  filter(trial_arm == "mrna-4157 + keytruda") %>%
  mutate(outcome_favorable = case_when (
    treatment_outcome %in% c("Complete Response", "Partial Response") ~ "Favorable",
    treatment_outcome %in% c("Stable Disease", "Progression") ~ "Unfavorable",
    TRUE ~ NA_character_
  )) %>%
  
  filter(!is.na(outcome_favorable)) %>%
  
  mutate(outcome_favorable = factor(outcome_favorable))
```
```{r}
table(df_new_target$outcome_favorable)
prop.table(table(df_new_target$outcome_favorable))
```
Ok now that we have the target variable and there is no imbalance, lets move on

```{r}
df_new_target %>% 
  summarise(across(everything(), ~sum(is.na(.)))) %>%
  pivot_longer(cols = everything(), names_to = "variable", values_to = "missing_count") %>%
  filter(missing_count > 0) %>%
  arrange(desc(missing_count))
```
```{r}
df_new_target %>%
  select_if(is.numeric) %>%  # more compatible with older dplyr versions
  pivot_longer(cols = everything(), names_to = "predictor", values_to = "value") %>%
  ggplot(aes(x = value)) +
  geom_histogram(bins = 30, fill = "blue", color = "white") +
  facet_wrap(~ predictor, scales = "free", ncol = 3) +
  labs(title = "Distribution of Numeric Predictors", x = "Value", y = "Count")


```
```{r}
df_polr <- df |> 
  filter(!is.na(treatment_outcome),
         treatment_outcome != "Unknown"
         )
```
```{r}
df_polr <- df_polr |>
  mutate(treatment_outcome = factor(
    treatment_outcome,
    levels = c("Progression", "Stable Disease", "Partial Response", "Complete Response"),
    ordered = TRUE
  ))
```
```{r}
df_polr |> 
  count(gender, sort = TRUE)
```
```{r}
df_polr <- df_polr |>
  mutate(across(where(is.character), as.factor))
```
```{r}
df_polr |>
  (\(df) summary(df[, c("age", "baseline_tumor_size_mm", "post_treatment_tumor_size_mm",
                        "immune_response_score", "treatment_duration_days")]))()
```
```{r}
df_polr |>
  filter(
    baseline_tumor_size_mm < 0 |
    post_treatment_tumor_size_mm < 0 |
    immune_response_score < 0
  ) |>
  nrow()

```
```{r}
df_polr <- df_polr |>
  filter(
    baseline_tumor_size_mm >= 0,
    post_treatment_tumor_size_mm >= 0,
    immune_response_score >= 0
  )
```

```{r}
df_polr |>
  summarise(
    n_missing_baseline = sum(is.na(baseline_tumor_size_mm)),
    n_missing_post = sum(is.na(post_treatment_tumor_size_mm)),
    n_missing_immune = sum(is.na(immune_response_score))
  )

```
```{r}
nrow(df_polr)
```
```{r}
df_polr |>
  summarise(across(everything(), ~ sum(is.na(.)))) |>
  pivot_longer(cols = everything(), names_to = "variable", values_to = "missing_count") |>
  filter(missing_count > 0)

```
```{r}
glimpse(df_polr)
```
Pre-processing
```{r}
df_polr <- df_polr |>
  mutate(tumor_size_change = baseline_tumor_size_mm - post_treatment_tumor_size_mm)
```
```{r}
df_polr <- df_polr |>
  select(-baseline_tumor_size_mm, -post_treatment_tumor_size_mm)

```



Near Zero Variance Predictors
```{r}
nzv <- nearZeroVar(df_polr, saveMetrics = TRUE)
nzv |> filter(nzv == TRUE)
```
```{r}
df_polr |>
  select_if(is.numeric) |>
  summarise(across(
    everything(),
    ~ skewness(.x, na.rm = TRUE)
  )) |>
  pivot_longer(cols = everything(), names_to = "variable", values_to = "skewness") |>
  arrange(desc(abs(skewness)))


```
```{r}
library(bestNormalize)

# Transform immune_response_score
yj_immune <- yeojohnson(df_polr$immune_response_score)

df_polr <- df_polr |>
  mutate(immune_response_score = yj_immune$x.t)

```
Scale Numeric Predictors
```{r}
preProc <- preProcess(df_polr, method = c("center", "scale"))
df_polr <- predict(preProc, df_polr)

```
Check Correlation
```{r}
num_vars <- df_polr |>
  select(where(is.numeric))

cor_matrix <- cor(num_vars, use = "pairwise.complete.obs")

high_corr <- findCorrelation(cor_matrix, cutoff = 0.9)

names(num_vars)[high_corr]
```
```{r}
glimpse(df_polr)
```
```{r}
df_polr <- df_polr |>
  mutate(across(where(~ is.matrix(.x)), ~ as.numeric(.x)))
```
```{r}
glimpse(df_polr)
```
EDA
```{r}
df_polr |>
  pivot_longer(cols = c(age, immune_response_score, treatment_duration_days, tumor_size_change),
               names_to = "predictor", values_to = "value") |>
  ggplot(aes(x = treatment_outcome, y = value)) +
  geom_boxplot(fill = "lightblue") +
  facet_wrap(~ predictor, scales = "free", ncol = 2) +  # only 2 per row
  labs(title = "Numeric Predictors vs. Treatment Outcome") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

```{r}
df_polr |>
  count(trial_arm, treatment_outcome) |>
  group_by(trial_arm) |>
  mutate(prop = n / sum(n)) |>
  ggplot(aes(x = treatment_outcome, y = prop, fill = trial_arm)) +
  geom_col(position = "dodge") +
  labs(title = "Treatment Outcome by Trial Arm")

```
Splitting and Cross validation
```{r}
library(MASS)
set.seed(42)

split_index <- createDataPartition(df_polr$treatment_outcome, p = 0.8, list = FALSE)
train_polr <- df_polr[split_index, ]
test_polr  <- df_polr[-split_index, ]
```
```{r}
ctrl <- trainControl(
  method = "repeatedcv",
  number = 10,
  repeats = 3
)

polr_model <- train(
  treatment_outcome ~ age + gender + cancer_type + trial_arm + 
    immune_response_score + treatment_duration_days + tumor_size_change,
  data = train_polr,
  method = "polr",
  trControl = ctrl,
  preProcess = c("center", "scale")
)
```
```{r}
polr_model
```





